# Інструкції з міграції зон доставки

## Огляд

Ця міграція додає підтримку полігонних зон доставки до існуючої системи. Всі існуючі зони автоматично стануть типу "радіус".

## Кроки для розгортання

### 1. Запустити міграційний скрипт

Міграційний скрипт оновить всі існуючі зони, додавши поле `zone_type = "radius"`.

```bash
cd "c:\New folder\pos"
python -m backend.migrations.migrate_add_zone_type
```

Очікуваний вивід:
```
============================================================
Delivery Zones Migration
============================================================
Starting migration: Add zone_type to delivery zones...
Found X zones without zone_type field.
Setting zone_type='radius' for all existing zones...
✓ Migration completed successfully!
  - Updated X zones
  - All existing zones now have zone_type='radius'

✓ Migration completed successfully!
```

### 2. Перезапустити сервер

Після міграції перезапустіть backend сервер, щоб застосувати нові зміни моделі:

```bash
# Зупинити існуючий сервер (Ctrl+C)
# Запустити знову
python -m backend.main
```

### 3. Перевірити функціонал

Відкрийте адмін панель зон доставки та перевірте:

#### Тестування радіусних зон (існуючий функціонал):
- ✅ Існуючі зони відображаються коректно
- ✅ Можна створити нову радіусну зону
- ✅ Можна редагувати існуючу радіусну зону
- ✅ Зміна радіусу оновлює геометрію на карті

#### Тестування полігонних зон (новий функціонал):
- ✅ Селектор типу зони відображається
- ✅ При виборі "Полігон" з'являються інструменти малювання
- ✅ Можна намалювати полігон на карті
- ✅ Полігон можна редагувати перетягуванням вершин
- ✅ Полігонна зона зберігається в БД
- ✅ У таблиці зон відображається бейдж "Полігон"
- ✅ Детекція адреси працює для полігонних зон

#### Змішане тестування:
- ✅ На карті коректно відображаються обидва типи зон
- ✅ Зміна центру доставки перераховує тільки радіусні зони

## Відкат (якщо потрібно)

Якщо виникнуть проблеми:

1. **Приховати UI для полігонів** (швидке рішення):
   - Відредагувати `frontend/templates/admin/delivery_zones.html`
   - Знайти селектор типу зони
   - Встановити `x-show="false"` для опції "Полігон"

2. **Повний відкат**:
   - Відновити backup файлів з git
   - Backend залишиться сумісним, оскільки `zone_type` має дефолтне значення

## Примітки

- **Зворотна сумісність**: Backend API повністю зворотно сумісний. Старі клієнти продовжать працювати.
- **Продуктивність**: Полігонні зони використовують ті ж індекси MongoDB 2dsphere, що й радіусні.
- **Обмеження**: Максимум 1000 вершин на полігон для запобігання DoS атакам.
