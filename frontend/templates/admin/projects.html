{% extends "admin/base.html" %}

{% block page_title %}Проєкти{% endblock %}

{% block content %}
<div x-data="projectsApp()" x-init="init()">
    <!-- Header -->
    <div class="page-header">
        <button class="btn btn-primary" @click="openModal()">
            <svg viewBox="0 0 24 24" width="18" height="18"><path fill="currentColor" d="M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z"/></svg>
            Додати проєкт
        </button>
    </div>

    <!-- Projects Table -->
    <div class="card">
        <div class="table-wrapper">
            <table class="table" x-show="projects.length > 0">
                <thead>
                    <tr>
                        <th>Назва</th>
                        <th>Порядок</th>
                        <th>Категорій</th>
                        <th>Дії</th>
                    </tr>
                </thead>
                <tbody>
                    <template x-for="proj in projects" :key="proj._id">
                        <tr>
                            <td x-text="proj.name"></td>
                            <td x-text="proj.sort_order"></td>
                            <td x-text="categoryCount(proj._id)"></td>
                            <td>
                                <button class="btn-icon danger"
                                        @click="deleteProject(proj._id)"
                                        :disabled="categoryCount(proj._id) > 0"
                                        :title="categoryCount(proj._id) > 0 ? 'Спочатку видаліть або перенесіть категорії' : 'Видалити'">
                                    <svg viewBox="0 0 24 24" width="20" height="20"><path fill="currentColor" d="M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z"/></svg>
                                </button>
                            </td>
                        </tr>
                    </template>
                </tbody>
            </table>
        </div>

        <div class="empty-state" x-show="projects.length === 0">
            <h3>Проєкти відсутні</h3>
            <p>Створіть перший проєкт, щоб організувати категорії</p>
        </div>
    </div>

    <!-- Add Modal -->
    <div class="modal" x-show="showModal" x-transition @click.self="showModal = false">
        <div class="modal-content modal-form">
            <div class="modal-header">
                <h3>Новий проєкт</h3>
                <button @click="showModal = false">&times;</button>
            </div>
            <form @submit.prevent="saveProject()">
                <div class="modal-body">
                    <div class="form-group">
                        <label class="form-label">Назва</label>
                        <input type="text" class="form-input" x-model="form.name" required placeholder="Наприклад: Кавʼярня">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Порядок сортування</label>
                        <input type="number" class="form-input" x-model="form.sort_order">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline" @click="showModal = false">Скасувати</button>
                    <button type="submit" class="btn btn-primary">Додати</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function projectsApp() {
    return {
        projects: [],
        categories: [],
        showModal: false,
        form: { name: '', sort_order: 0 },

        async init() {
            await Promise.all([this.loadProjects(), this.loadCategories()]);
        },

        async loadProjects() {
            try {
                const res = await fetch('/api/projects');
                this.projects = await res.json();
            } catch (e) {
                console.error('Error loading projects:', e);
            }
        },

        async loadCategories() {
            try {
                const res = await fetch('/api/categories');
                this.categories = await res.json();
            } catch (e) {
                console.error('Error loading categories:', e);
            }
        },

        categoryCount(projectId) {
            return this.categories.filter(c => c.project_id === projectId).length;
        },

        openModal() {
            this.form = { name: '', sort_order: this.projects.length };
            this.showModal = true;
        },

        async saveProject() {
            try {
                await fetch('/api/projects', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(this.form)
                });
                this.showModal = false;
                await this.loadProjects();
            } catch (e) {
                console.error('Error saving project:', e);
            }
        },

        async deleteProject(id) {
            if (!confirm('Видалити цей проєкт?')) return;
            try {
                const res = await fetch(`/api/projects/${id}`, { method: 'DELETE' });
                if (!res.ok) {
                    const data = await res.json();
                    alert(data.detail || 'Помилка видалення');
                    return;
                }
                await this.loadProjects();
            } catch (e) {
                console.error('Error deleting project:', e);
            }
        }
    };
}
</script>
{% endblock %}
