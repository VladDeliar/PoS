{% extends "admin/base.html" %}

{% block page_title %}Управління меню{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="/static/css/dishes.css">
{% endblock %}

{% block content %}
<div class="admin-content dishes-page" x-data="menuApp()" x-init="init()">

    <!-- Green Header Bar -->
    <div class="dishes-header">
        <!-- Left: Stats -->
        <div class="header-tabs">
            <div style="display: flex; gap: 24px; align-items: center;">
                <div style="text-align: center;">
                    <div style="font-size: 1.4rem; font-weight: 700; color: white; line-height: 1;" x-text="menuItems.length"></div>
                    <div style="font-size: 0.75rem; color: rgba(255,255,255,0.8);">позицій</div>
                </div>
                <div style="width: 1px; height: 32px; background: rgba(255,255,255,0.3);"></div>
                <div style="text-align: center;">
                    <div style="font-size: 1.4rem; font-weight: 700; color: white; line-height: 1;" x-text="menuItems.filter(i => i.is_active).length"></div>
                    <div style="font-size: 0.75rem; color: rgba(255,255,255,0.8);">активних</div>
                </div>
            </div>
        </div>

        <!-- Center: Search (filters left column) -->
        <div class="header-search">
            <svg class="search-icon" viewBox="0 0 24 24">
                <path d="M9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.44,13.73L14.71,14H15.5L20.5,19L19,20.5L14,15.5V14.71L13.73,14.44C12.59,15.41 11.11,16 9.5,16A6.5,6.5 0 0,1 3,9.5A6.5,6.5 0 0,1 9.5,3M9.5,5C7,5 5,7 5,9.5C5,12 7,14 9.5,14C12,14 14,12 14,9.5C14,7 12,5 9.5,5Z"/>
            </svg>
            <input type="text"
                   x-model="searchQuery"
                   @input="filterProducts()"
                   placeholder="Пошук страв для додавання...">
        </div>

        <!-- Right: Category filter for active menu -->
        <div class="header-actions">
            <select class="menu-category-select"
                    x-model="categoryFilter"
                    @change="filterMenuItems()">
                <option value="">Всі категорії</option>
                <template x-for="cat in categories" :key="cat._id">
                    <option :value="cat._id" x-text="cat.name"></option>
                </template>
            </select>
        </div>
    </div>

    <!-- Two Column Layout -->
    <div class="dishes-content">
        <div class="menu-columns">

            <!-- Left: Available Products & Combos -->
            <div class="menu-panel">
                <div class="menu-panel-header">
                    <h3>Асортимент</h3>
                    <div class="source-tabs">
                        <button class="category-pill" style="padding: 4px 14px; font-size: 0.8rem;"
                                :class="{ active: sourceTab === 'products' }"
                                @click="sourceTab = 'products'">Страви</button>
                        <button class="category-pill" style="padding: 4px 14px; font-size: 0.8rem;"
                                :class="{ active: sourceTab === 'combos' }"
                                @click="sourceTab = 'combos'">Комбо</button>
                    </div>
                </div>

                <div class="menu-panel-body">
                    <!-- Products List -->
                    <template x-if="sourceTab === 'products'">
                        <div>
                            <template x-for="product in filteredProducts" :key="product._id">
                                <div class="available-item" @click="addProductToMenu(product)">
                                    <img :src="product.image" :alt="product.name"
                                         onerror="this.src='/static/img/placeholder.png'">
                                    <div class="available-item-info">
                                        <span class="available-item-name" x-text="product.name"></span>
                                        <span class="available-item-meta" x-text="getCategoryName(product.category_id)"></span>
                                    </div>
                                    <span class="available-item-price" x-text="product.price + ' грн'"></span>
                                    <button class="btn-add-item" title="Додати в меню">
                                        <svg viewBox="0 0 24 24" width="16" height="16"><path fill="currentColor" d="M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z"/></svg>
                                    </button>
                                </div>
                            </template>
                            <div class="menu-empty-msg" x-show="filteredProducts.length === 0">
                                <p x-show="searchQuery">Нічого не знайдено</p>
                                <p x-show="!searchQuery && availableProducts.length === 0">Всі страви вже в меню</p>
                            </div>
                        </div>
                    </template>

                    <!-- Combos List -->
                    <template x-if="sourceTab === 'combos'">
                        <div>
                            <template x-for="combo in availableCombos" :key="combo._id">
                                <div class="available-item combo-source" @click="openCategoryModal(combo)">
                                    <img :src="combo.image || '/static/img/placeholder.svg'" :alt="combo.name"
                                         onerror="this.src='/static/img/placeholder.png'">
                                    <div class="available-item-info">
                                        <div style="display: flex; align-items: center; gap: 6px;">
                                            <span class="available-item-name" x-text="combo.name"></span>
                                            <span class="combo-badge-sm">КОМБО</span>
                                        </div>
                                        <div style="display: flex; gap: 8px; align-items: center;">
                                            <span style="text-decoration: line-through; font-size: 0.78rem; color: var(--color-text-secondary);"
                                                  x-text="combo.regular_price + ' грн'"></span>
                                            <span style="font-weight: 600; font-size: 0.85rem; color: var(--color-primary);"
                                                  x-text="combo.combo_price + ' грн'"></span>
                                        </div>
                                    </div>
                                    <button class="btn-add-item" title="Додати в меню">
                                        <svg viewBox="0 0 24 24" width="16" height="16"><path fill="currentColor" d="M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z"/></svg>
                                    </button>
                                </div>
                            </template>
                            <div class="menu-empty-msg" x-show="availableCombos.length === 0">
                                <p>Немає доступних комбо</p>
                                <a href="/admin/combos" style="color: var(--color-primary);">Створити комбо</a>
                            </div>
                        </div>
                    </template>
                </div>
            </div>

            <!-- Right: Active Menu -->
            <div class="menu-panel menu-panel-active">
                <div class="menu-panel-header" style="background: var(--color-primary-light);">
                    <h3 style="color: var(--color-primary);">Активне меню</h3>
                    <span style="font-size: 0.78rem; color: var(--color-text-secondary); font-style: italic;">
                        Перетягуйте для сортування
                    </span>
                </div>

                <div class="menu-panel-body" id="menuList">
                    <template x-for="(item, index) in filteredMenuItems" :key="item.menu_item_id || item._id">
                        <div class="menu-active-item"
                             :class="{ inactive: !item.is_active, dragging: draggedIndex === index, 'combo-border': item.item_type === 'combo' }"
                             draggable="true"
                             @dragstart="dragStart($event, index)"
                             @dragover.prevent="dragOver($event, index)"
                             @dragend="dragEnd()"
                             @drop="drop($event, index)">

                            <!-- Position -->
                            <div class="item-pos-badge" x-text="index + 1"></div>

                            <!-- Drag Handle -->
                            <div class="drag-handle" title="Перетягніть для зміни порядку">
                                <svg viewBox="0 0 24 24" width="18" height="18"><path fill="currentColor" d="M9,3H11V5H9V3M13,3H15V5H13V3M9,7H11V9H9V7M13,7H15V9H13V7M9,11H11V13H9V11M13,11H15V13H13V11M9,15H11V17H9V15M13,15H15V17H13V15M9,19H11V21H9V19M13,19H15V21H13V19Z"/></svg>
                            </div>

                            <!-- Image -->
                            <img :src="item.image" :alt="item.name"
                                 style="width: 44px; height: 44px; border-radius: 8px; object-fit: cover; flex-shrink: 0;"
                                 onerror="this.src='/static/img/placeholder.png'">

                            <!-- Info -->
                            <div style="flex: 1; min-width: 0;">
                                <div style="display: flex; align-items: center; gap: 6px;">
                                    <span style="font-weight: 500; font-size: 0.875rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;"
                                          x-text="item.name"></span>
                                    <span class="combo-badge-sm" x-show="item.item_type === 'combo'">КОМБО</span>
                                </div>
                                <span style="font-size: 0.78rem; color: var(--color-text-secondary);"
                                      x-text="getCategoryName(item.category_id)"></span>
                                <template x-if="item.item_type === 'combo'">
                                    <span style="font-size: 0.78rem; color: var(--color-primary); font-weight: 500;"
                                          x-text="'Економія ' + item.savings + ' грн'"></span>
                                </template>
                                <div style="font-size: 0.85rem; font-weight: 600; color: var(--color-primary);"
                                     x-text="item.price + ' грн'"></div>
                            </div>

                            <!-- Actions -->
                            <div style="display: flex; gap: 4px; align-items: center;">
                                <!-- Active Toggle -->
                                <div class="status-toggle"
                                     :class="{ on: item.is_active }"
                                     @click="toggleActive(item)"
                                     :title="item.is_active ? 'Деактивувати' : 'Активувати'"
                                     style="flex-shrink: 0;">
                                </div>

                                <!-- Remove -->
                                <button class="action-icon delete" @click="removeFromMenu(item)" title="Прибрати з меню"
                                        style="margin-left: 4px;">
                                    <svg viewBox="0 0 24 24">
                                        <path d="M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </template>

                    <div class="menu-empty-msg" x-show="menuItems.length === 0">
                        <svg viewBox="0 0 24 24" width="48" height="48" style="fill: var(--color-border); margin-bottom: 12px;">
                            <path d="M12,3L1,9L12,15L21,10.09V17H23V9M5,13.18V17.18L12,21L19,17.18V13.18L12,17L5,13.18Z"/>
                        </svg>
                        <p style="font-weight: 500;">Меню порожнє</p>
                        <p style="font-size: 0.85rem;">Додайте страви з асортименту зліва</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Category Selection Modal (for Combos) -->
    <div class="category-modal-overlay" x-show="showCategoryModal" x-cloak x-transition.opacity @click.self="showCategoryModal = false">
        <div class="category-modal-box" @click.stop>
            <div class="category-modal-head">
                <h3>Оберіть категорію</h3>
                <button class="modal-close-btn" @click="showCategoryModal = false">&times;</button>
            </div>
            <div class="category-modal-body">
                <p class="modal-hint">В яку категорію додати "<strong x-text="selectedCombo?.name"></strong>"?</p>
                <div class="category-options-grid">
                    <template x-for="cat in categories" :key="cat._id">
                        <button class="category-option-btn" @click="addComboWithCategory(cat._id)">
                            <span x-text="cat.name"></span>
                        </button>
                    </template>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* Menu columns layout */
.menu-columns {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
}

@media (max-width: 900px) {
    .menu-columns {
        grid-template-columns: 1fr;
    }
    .menu-panel {
        max-height: 400px;
    }
}

/* Panel container */
.menu-panel {
    background: var(--color-bg-card);
    border-radius: 12px;
    box-shadow: var(--shadow-card);
    overflow: hidden;
    display: flex;
    flex-direction: column;
    max-height: calc(100vh - 160px);
    border: 1px solid var(--color-border);
}

.menu-panel-header {
    padding: 14px 16px;
    border-bottom: 1px solid var(--color-border);
    background: var(--color-bg-body);
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-shrink: 0;
}

.menu-panel-header h3 {
    margin: 0;
    font-size: 0.95rem;
    font-weight: 600;
    color: var(--color-text-primary);
}

.menu-panel-body {
    flex: 1;
    overflow-y: auto;
    padding: 10px;
}

/* Available item row */
.available-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 10px;
    background: var(--color-bg-body);
    border-radius: 8px;
    margin-bottom: 6px;
    cursor: pointer;
    transition: all 0.2s;
    border: 1px solid transparent;
}

.available-item:hover {
    background: var(--color-primary-light);
    border-color: var(--color-primary);
    transform: translateX(2px);
}

.available-item:hover .btn-add-item {
    opacity: 1;
}

.available-item img {
    width: 40px;
    height: 40px;
    border-radius: 6px;
    object-fit: cover;
    flex-shrink: 0;
}

.available-item-info {
    flex: 1;
    min-width: 0;
}

.available-item-name {
    display: block;
    font-weight: 500;
    font-size: 0.875rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    color: var(--color-text-primary);
}

.available-item-meta {
    display: block;
    font-size: 0.75rem;
    color: var(--color-text-secondary);
}

.available-item-price {
    font-weight: 600;
    font-size: 0.875rem;
    color: var(--color-primary);
    white-space: nowrap;
    flex-shrink: 0;
}

.btn-add-item {
    width: 28px;
    height: 28px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--color-primary);
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    opacity: 0;
    transition: opacity 0.2s;
    flex-shrink: 0;
}

.combo-source {
    border-left: 3px solid var(--color-primary);
}

/* Active menu item */
.menu-active-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px;
    background: var(--color-bg-card);
    border: 1px solid var(--color-border);
    border-radius: 8px;
    margin-bottom: 8px;
    cursor: grab;
    transition: all 0.2s;
}

.menu-active-item:active {
    cursor: grabbing;
}

.menu-active-item.inactive {
    opacity: 0.45;
    border-left: 3px solid var(--color-danger);
}

.menu-active-item.dragging {
    opacity: 0.4;
    background: var(--color-primary-light);
}

.menu-active-item.drag-over {
    border-top: 2px solid var(--color-primary);
}

.menu-active-item.combo-border {
    border-left: 3px solid var(--color-primary);
}

/* Position badge */
.item-pos-badge {
    width: 26px;
    height: 26px;
    background: var(--color-primary);
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 0.78rem;
    flex-shrink: 0;
}

/* Drag handle */
.drag-handle {
    color: var(--color-text-secondary);
    cursor: grab;
    padding: 2px;
    border-radius: 4px;
    transition: all 0.2s;
    flex-shrink: 0;
}

.drag-handle:hover {
    color: var(--color-primary);
}

/* Combo badge small */
.combo-badge-sm {
    background: var(--color-primary);
    color: white;
    padding: 1px 5px;
    border-radius: 3px;
    font-size: 0.65rem;
    font-weight: 700;
    flex-shrink: 0;
}

/* Empty message */
.menu-empty-msg {
    text-align: center;
    padding: 40px 20px;
    color: var(--color-text-secondary);
}

.menu-empty-msg p {
    margin: 4px 0;
}

/* Category select in header */
.menu-category-select {
    padding: 7px 12px;
    background: rgba(255, 255, 255, 0.2);
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-radius: 8px;
    color: white;
    font-size: 0.875rem;
    cursor: pointer;
    backdrop-filter: blur(10px);
    transition: all 0.2s;
}

.menu-category-select:focus {
    outline: none;
    background: rgba(255, 255, 255, 0.3);
}

.menu-category-select option {
    background: var(--color-bg-card);
    color: var(--color-text-primary);
}

/* Category Modal */
.category-modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.55);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    backdrop-filter: blur(4px);
}

.category-modal-box {
    background: var(--color-bg-card);
    border: 1px solid var(--color-border);
    border-radius: 16px;
    width: 90%;
    max-width: 440px;
    overflow: hidden;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
    animation: modalIn 0.2s ease-out;
}

@keyframes modalIn {
    from { opacity: 0; transform: scale(0.95) translateY(-10px); }
    to { opacity: 1; transform: scale(1) translateY(0); }
}

.category-modal-head {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 18px 24px;
    background: var(--color-primary);
    color: white;
}

.category-modal-head h3 {
    margin: 0;
    font-size: 1.1rem;
    font-weight: 600;
}

.modal-close-btn {
    background: rgba(255, 255, 255, 0.25);
    border: none;
    font-size: 1.3rem;
    cursor: pointer;
    color: white;
    padding: 2px 10px;
    border-radius: 6px;
    line-height: 1;
    transition: background 0.2s;
}

.modal-close-btn:hover {
    background: rgba(255, 255, 255, 0.4);
}

.category-modal-body {
    padding: 24px;
}

.modal-hint {
    margin: 0 0 20px 0;
    color: var(--color-text-secondary);
    font-size: 0.95rem;
    line-height: 1.5;
}

.modal-hint strong {
    color: var(--color-primary);
}

.category-options-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 10px;
}

.category-option-btn {
    padding: 14px;
    background: var(--color-bg-body);
    border: 2px solid var(--color-border);
    border-radius: 10px;
    cursor: pointer;
    text-align: center;
    font-size: 0.9rem;
    font-weight: 500;
    color: var(--color-text-primary);
    transition: all 0.2s;
}

.category-option-btn:hover {
    border-color: var(--color-primary);
    background: var(--color-primary-light);
    color: var(--color-primary);
    transform: translateY(-2px);
}

.category-option-btn:active {
    transform: translateY(0);
}
</style>

<script>
const categoriesData = {{ categories | tojson }};

function menuApp() {
    return {
        products: [],
        combos: [],
        menuItems: [],
        categories: categoriesData || [],
        searchQuery: '',
        categoryFilter: '',
        sourceTab: 'products',
        filteredProducts: [],
        filteredMenuItems: [],
        availableCombos: [],
        draggedIndex: null,
        showCategoryModal: false,
        selectedCombo: null,

        async init() {
            await Promise.all([
                this.loadProducts(),
                this.loadCombos(),
                this.loadMenuItems()
            ]);
            this.filterProducts();
            this.filterMenuItems();
        },

        async loadProducts() {
            try {
                const response = await fetch('/api/products');
                this.products = await response.json();
            } catch (error) {
                console.error('Error loading products:', error);
            }
        },

        async loadCombos() {
            try {
                const response = await fetch('/api/combos/available-for-menu');
                this.combos = await response.json();
                this.availableCombos = this.combos;
            } catch (error) {
                console.error('Error loading combos:', error);
            }
        },

        async loadMenuItems() {
            try {
                const response = await fetch('/api/menu-items?active_only=false');
                this.menuItems = await response.json();
                this.filterMenuItems();
            } catch (error) {
                console.error('Error loading menu items:', error);
            }
        },

        get availableProducts() {
            const menuProductIds = this.menuItems
                .filter(item => item.item_type !== 'combo')
                .map(item => item._id || item.product_id);
            return this.products.filter(p => !menuProductIds.includes(p._id));
        },

        filterProducts() {
            let filtered = this.availableProducts;
            if (this.searchQuery) {
                const query = this.searchQuery.toLowerCase();
                filtered = filtered.filter(p =>
                    p.name.toLowerCase().includes(query) ||
                    this.getCategoryName(p.category_id).toLowerCase().includes(query)
                );
            }
            this.filteredProducts = filtered;
        },

        filterMenuItems() {
            let filtered = [...this.menuItems];
            if (this.categoryFilter) {
                filtered = filtered.filter(item => item.category_id === this.categoryFilter);
            }
            filtered.sort((a, b) => (a.sort_order || 0) - (b.sort_order || 0));
            this.filteredMenuItems = filtered;
        },

        getCategoryName(catId) {
            const cat = this.categories.find(c => c._id === catId);
            return cat ? cat.name : '';
        },

        async addProductToMenu(product) {
            try {
                await fetch('/api/menu-items', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        item_type: 'product',
                        product_id: product._id,
                        is_active: true,
                        sort_order: this.menuItems.length
                    })
                });
                await this.loadMenuItems();
                this.filterProducts();
            } catch (error) {
                console.error('Error adding product to menu:', error);
            }
        },

        openCategoryModal(combo) {
            this.selectedCombo = combo;
            this.showCategoryModal = true;
        },

        async addComboWithCategory(categoryId) {
            if (!this.selectedCombo) return;
            try {
                await fetch('/api/menu-items', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        item_type: 'combo',
                        combo_id: this.selectedCombo._id,
                        category_id: categoryId,
                        is_active: true,
                        sort_order: this.menuItems.length
                    })
                });
                this.showCategoryModal = false;
                this.selectedCombo = null;
                await this.loadMenuItems();
                await this.loadCombos();
            } catch (error) {
                console.error('Error adding combo to menu:', error);
            }
        },

        async removeFromMenu(item) {
            const menuItemId = item.menu_item_id || item._id;
            try {
                await fetch(`/api/menu-items/${menuItemId}`, { method: 'DELETE' });
                await this.loadMenuItems();
                this.filterProducts();
                if (item.item_type === 'combo') await this.loadCombos();
            } catch (error) {
                console.error('Error removing from menu:', error);
            }
        },

        async toggleActive(item) {
            const menuItemId = item.menu_item_id || item._id;
            const isCombo = item.item_type === 'combo';
            try {
                const body = {
                    item_type: item.item_type || 'product',
                    is_active: !item.is_active,
                    sort_order: item.sort_order || 0,
                    category_id: item.category_id || null
                };
                if (isCombo) body.combo_id = item._id;
                else body.product_id = item._id || item.product_id;

                await fetch(`/api/menu-items/${menuItemId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                await this.loadMenuItems();
            } catch (error) {
                console.error('Error toggling active:', error);
            }
        },

        // Drag and drop
        dragStart(event, index) {
            this.draggedIndex = index;
            event.dataTransfer.effectAllowed = 'move';
            event.dataTransfer.setData('text/plain', index);
        },

        dragOver(event, index) {
            event.preventDefault();
            const items = document.querySelectorAll('.menu-active-item');
            items.forEach(item => item.classList.remove('drag-over'));
            if (index !== this.draggedIndex && this.draggedIndex !== null) {
                items[index]?.classList.add('drag-over');
            }
        },

        dragEnd() {
            this.draggedIndex = null;
            const items = document.querySelectorAll('.menu-active-item');
            items.forEach(item => item.classList.remove('drag-over'));
        },

        async drop(event, index) {
            event.preventDefault();
            const items = document.querySelectorAll('.menu-active-item');
            items.forEach(item => item.classList.remove('drag-over'));

            if (this.draggedIndex === null || this.draggedIndex === index) {
                this.draggedIndex = null;
                return;
            }

            const movedItem = this.filteredMenuItems.splice(this.draggedIndex, 1)[0];
            this.filteredMenuItems.splice(index, 0, movedItem);

            const updates = this.filteredMenuItems.map((item, idx) => ({
                _id: item.menu_item_id || item._id,
                sort_order: idx
            }));

            this.draggedIndex = null;

            try {
                const response = await fetch('/api/menu-items/reorder', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updates)
                });
                if (!response.ok) console.error('Reorder failed:', await response.text());
                await this.loadMenuItems();
            } catch (error) {
                console.error('Error reordering:', error);
                await this.loadMenuItems();
            }
        }
    };
}
</script>
{% endblock %}
