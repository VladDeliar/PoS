{% extends "base.html" %}

{% block title %}{{ restaurant_name }} - Меню{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="/static/css/menu.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
{% if font_family and font_family != 'system' %}
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family={{ font_family | replace(' ', '+') }}&display=swap">
{% endif %}
{% endblock %}

{% block body %}
<!-- Page Builder Preview Banner (shown only in preview mode) -->
<div id="pb-preview-banner" style="display:none; position:fixed; top:0; left:0; right:0; z-index:9999; background:#1565C0; color:#fff; font-size:13px; text-align:center; padding:7px 16px; font-family:sans-serif; align-items:center; justify-content:center; gap:10px; box-shadow:0 2px 8px rgba(0,0,0,0.3);">
    <svg viewBox="0 0 24 24" width="16" height="16" style="flex-shrink:0"><path fill="currentColor" d="M12,9A3,3 0 0,0 9,12A3,3 0 0,0 12,15A3,3 0 0,0 15,12A3,3 0 0,0 12,9M12,17A5,5 0 0,1 7,12A5,5 0 0,1 12,7A5,5 0 0,1 17,12A5,5 0 0,1 12,17M12,4.5C7,4.5 2.73,7.61 1,12C2.73,16.39 7,19.5 12,19.5C17,19.5 21.27,16.39 23,12C21.27,7.61 17,4.5 12,4.5Z"/></svg>
    <span><strong>Preview Mode</strong> — відображається поточна конфігурація з Page Builder (зміни не збережено)</span>
</div>
<div x-data="menuApp()" class="menu-container">
    <!-- Header -->
    <header class="menu-header">
        <div class="header-content">
            <a href="/" class="logo">
                <div class="logo-icon">
                    <svg viewBox="0 0 24 24"><path d="M2,21V19H20V21H2M20,8V5H18V8H20M20,3A2,2 0 0,1 22,5V8A2,2 0 0,1 20,10H18V13A4,4 0 0,1 14,17H8A4,4 0 0,1 4,13V3H20M16,5H6V13A2,2 0 0,0 8,15H14A2,2 0 0,0 16,13V5Z"/></svg>
                </div>
                <span>{{ restaurant_name }}</span>
            </a>

            <nav class="main-nav">
                <a href="/" class="nav-item">Головна</a>
                <a href="/menu" class="nav-item active">Меню</a>
                <template x-for="sp in sitePages" :key="sp._id">
                    <a :href="'/pages/' + sp._id" class="nav-item" x-text="sp.title"></a>
                </template>
                <a href="#" class="nav-item" @click.prevent="showFeedback = true">Залишити відгук</a>
            </nav>

            <div class="header-actions">
                <button class="theme-toggle" @click="theme = theme === 'light' ? 'dark' : 'light'"
                        :title="theme === 'light' ? 'Темна тема' : 'Світла тема'">
                    <svg x-show="theme === 'light'" viewBox="0 0 24 24"><path d="M17.75,4.09L15.22,6.03L16.13,9.09L13.5,7.28L10.87,9.09L11.78,6.03L9.25,4.09L12.44,4L13.5,1L14.56,4L17.75,4.09M21.25,11L19.61,12.25L20.2,14.23L18.5,13.06L16.8,14.23L17.39,12.25L15.75,11L17.81,10.95L18.5,9L19.19,10.95L21.25,11M18.97,15.95C19.8,15.87 20.69,17.05 20.16,17.8C19.84,18.25 19.5,18.67 19.08,19.07C15.17,23 8.84,23 4.94,19.07C1.03,15.17 1.03,8.83 4.94,4.93C5.34,4.53 5.76,4.17 6.21,3.85C6.96,3.32 8.14,4.21 8.06,5.04C7.79,7.9 8.75,10.87 10.95,13.06C13.14,15.26 16.1,16.22 18.97,15.95Z"/></svg>
                    <svg x-show="theme === 'dark'" viewBox="0 0 24 24"><path d="M12,7A5,5 0 0,1 17,12A5,5 0 0,1 12,17A5,5 0 0,1 7,12A5,5 0 0,1 12,7M12,9A3,3 0 0,0 9,12A3,3 0 0,0 12,15A3,3 0 0,0 15,12A3,3 0 0,0 12,9M12,2L14.39,5.42C13.65,5.15 12.84,5 12,5C11.16,5 10.35,5.15 9.61,5.42L12,2M3.34,7L7.5,6.65C6.9,7.16 6.36,7.78 5.94,8.5C5.5,9.24 5.25,10 5.11,10.79L3.34,7M3.36,17L5.12,13.23C5.26,14 5.53,14.78 5.95,15.5C6.37,16.24 6.91,16.86 7.5,17.37L3.36,17M20.65,7L18.88,10.79C18.74,10 18.47,9.23 18.05,8.5C17.63,7.78 17.1,7.15 16.5,6.64L20.65,7M20.64,17L16.5,17.36C17.09,16.85 17.62,16.22 18.04,15.5C18.46,14.77 18.73,14 18.87,13.21L20.64,17M12,22L9.59,18.56C10.33,18.83 11.14,19 12,19C12.82,19 13.63,18.83 14.37,18.56L12,22Z"/></svg>
                </button>
                <button class="cart-btn" @click="showCart = true" aria-label="Кошик">
                    <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M17,18C15.89,18 15,18.89 15,20A2,2 0 0,0 17,22A2,2 0 0,0 19,20C19,18.89 18.1,18 17,18M1,2V4H3L6.6,11.59L5.24,14.04C5.09,14.32 5,14.65 5,15A2,2 0 0,0 7,17H19V15H7.42A0.25,0.25 0 0,1 7.17,14.75C7.17,14.7 7.18,14.66 7.2,14.63L8.1,13H15.55C16.3,13 16.96,12.58 17.3,11.97L20.88,5.5C20.95,5.34 21,5.17 21,5A1,1 0 0,0 20,4H5.21L4.27,2M7,18C5.89,18 5,18.89 5,20A2,2 0 0,0 7,22A2,2 0 0,0 9,20C9,18.89 8.1,18 7,18Z"/></svg>
                    <span aria-live="polite" x-text="cart.length > 0 ? cart.reduce((a,b) => a + b.qty, 0) + ' товарів' : 'Корзина порожня'"></span>
                </button>
            </div>
        </div>
    </header>

    <!-- Media Slider -->
    <template x-if="sliderEnabled && sliderItems.length > 0">
        <div class="media-slider">
            <div class="slider-track"
                 :style="'transform: translateX(-' + (sliderActive * 100) + '%)'">
                <template x-for="(item, idx) in sliderItems" :key="item.id">
                    <div class="slider-slide"
                         :class="{ 'slider-slide-dish': item.type === 'dish' }"
                         @click="item.type === 'dish' ? addToCartFromSlider(item) : null">
                        <img :src="item.type === 'dish' ? (item.image || '/static/img/placeholder.svg') : item.url"
                             :alt="item.name || ''"
                             onerror="this.src='/static/img/placeholder.svg'">
                        <div class="slider-dish-label" x-show="item.type === 'dish'" x-text="item.name"></div>
                    </div>
                </template>
            </div>

            <button class="slider-arrow slider-prev"
                    @click="sliderPrev()"
                    x-show="sliderItems.length > 1"
                    aria-label="Попередній">&#8249;</button>
            <button class="slider-arrow slider-next"
                    @click="sliderNext()"
                    x-show="sliderItems.length > 1"
                    aria-label="Наступний">&#8250;</button>

            <div class="slider-dots" x-show="sliderItems.length > 1">
                <template x-for="(item, idx) in sliderItems" :key="'dot' + idx">
                    <button class="slider-dot"
                            :class="{ active: sliderActive === idx }"
                            @click="sliderGoTo(idx)"
                            :aria-label="'Слайд ' + (idx + 1)"></button>
                </template>
            </div>
        </div>
    </template>

    <!-- V2 Page Sections -->
    <div class="page-sections">
        <template x-for="section in getVisibleSections()" :key="section.id">
            <div class="page-section" :style="getSectionStyles(section)">
                <div class="page-section-inner">
                    <template x-for="row in getVisibleRows(section)" :key="row.id">
                        <div class="page-row" :style="getRowStyles(row)">
                            <template x-for="col in row.columns" :key="col.id">
                                <div class="page-column" :class="getColumnClass(col)">
                                    <template x-for="el in getVisibleElements(col)" :key="el.id">
                                        <div class="page-element">

                                            <!-- Order Types -->
                                            <template x-if="el.type === 'order_types'">
                                                <div class="order-type-bar" :class="'ot-style-' + (el.settings?.style || 'pills')">
                                                    <template x-for="ot in availableOrderTypes" :key="ot.type">
                                                        <button class="ot-option"
                                                                :class="{ active: orderType === ot.type }"
                                                                @click="orderType = ot.type"
                                                                x-text="ot.label || ot.type">
                                                        </button>
                                                    </template>
                                                </div>
                                            </template>

                                            <!-- Announcement -->
                                            <template x-if="el.type === 'announcement'">
                                                <div class="announcement-bar"
                                                     :style="'background:' + (el.settings?.bgColor || '#FFF3E0') + ';color:' + (el.settings?.textColor || '#E65100')"
                                                     x-text="el.settings?.text || ''"></div>
                                            </template>

                                            <!-- Image / Hero Banner -->
                                            <template x-if="el.type === 'image'">
                                                <div class="image-element">
                                                    <template x-if="el.settings?.linkUrl">
                                                        <a :href="el.settings.linkUrl">
                                                            <img :src="el.settings?.imageUrl || ''" :alt="el.settings?.altText || ''"
                                                                 :style="'width:' + (el.settings?.width || '100%') + ';border-radius:' + (el.settings?.borderRadius || '8px') + ';display:block;max-width:100%;height:auto'">
                                                        </a>
                                                    </template>
                                                    <template x-if="!el.settings?.linkUrl">
                                                        <img :src="el.settings?.imageUrl || ''" :alt="el.settings?.altText || ''"
                                                             :style="'width:' + (el.settings?.width || '100%') + ';border-radius:' + (el.settings?.borderRadius || '8px') + ';display:block;max-width:100%;height:auto'">
                                                    </template>
                                                </div>
                                            </template>

                                            <!-- Text -->
                                            <template x-if="el.type === 'text'">
                                                <div class="text-element"
                                                     :style="'font-size:' + (el.settings?.fontSize || '1rem') + ';color:' + (el.settings?.color || 'inherit') + ';text-align:' + (el.settings?.textAlign || 'left') + ';padding:' + (el.settings?.padding || '0')"
                                                     x-html="el.settings?.content || ''"></div>
                                            </template>

                                            <!-- Menu (full product catalog) -->
                                            <template x-if="el.type === 'menu'">
                                                <div class="menu-body" :class="menuBodyClass">
                                                    <aside class="categories-sidebar" role="tablist" aria-label="Категорії меню">
                                                        <template x-for="cat in categories" :key="cat._id">
                                                            <button class="category-item"
                                                                    :class="{ active: selectedCategory === cat._id }"
                                                                    :data-cat-id="cat._id"
                                                                    @click="scrollToCategory(cat._id)"
                                                                    role="tab"
                                                                    :aria-selected="(selectedCategory === cat._id).toString()">
                                                                <span class="cat-icon" x-html="getCategoryIcon(cat.icon)"></span>
                                                                <span x-text="cat.name"></span>
                                                            </button>
                                                        </template>
                                                    </aside>

                                                    <main class="products-main">
                                                        <div class="products-header">
                                                            <div class="header-titles">
                                                                <h1>МЕНЮ</h1>
                                                                <h2 x-text="searchQuery ? 'Результати пошуку' : (selectedCategory ? getCategoryName(selectedCategory) : '')"></h2>
                                                            </div>
                                                            <div class="search-box">
                                                                <svg viewBox="0 0 24 24" class="search-icon"><path d="M9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.44,13.73L14.71,14H15.5L20.5,19L19,20.5L14,15.5V14.71L13.73,14.44C12.59,15.41 11.11,16 9.5,16A6.5,6.5 0 0,1 3,9.5A6.5,6.5 0 0,1 9.5,3M9.5,5C7,5 5,7 5,9.5C5,12 7,14 9.5,14C12,14 14,12 14,9.5C14,7 12,5 9.5,5Z"/></svg>
                                                                <input type="text" x-model="searchQuery" placeholder="Пошук страв..." class="search-input">
                                                                <button x-show="searchQuery" @click="searchQuery = ''" class="search-clear" aria-label="Очистити пошук"><span aria-hidden="true">&times;</span></button>
                                                            </div>
                                                            <span class="search-results-count" x-show="searchQuery" x-text="filteredProducts.length + ' знайдено'"></span>
                                                        </div>

                                                        <div x-show="tableNumber" class="table-indicator">
                                                            <svg viewBox="0 0 24 24"><path d="M12,6C8.67,6 6,8.67 6,12A6,6 0 0,0 12,18A6,6 0 0,0 18,12C18,8.67 15.33,6 12,6M12,16A4,4 0 0,1 8,12A4,4 0 0,1 12,8A4,4 0 0,1 16,12A4,4 0 0,1 12,16M12,4A2,2 0 0,1 14,6A2,2 0 0,1 12,8A2,2 0 0,1 10,6A2,2 0 0,1 12,4M20,10A2,2 0 0,1 22,12A2,2 0 0,1 20,14A2,2 0 0,1 18,12A2,2 0 0,1 20,10M20,4A2,2 0 0,1 22,6A2,2 0 0,1 20,8A2,2 0 0,1 18,6A2,2 0 0,1 20,4M4,10A2,2 0 0,1 6,12A2,2 0 0,1 4,14A2,2 0 0,1 2,12A2,2 0 0,1 4,10M4,4A2,2 0 0,1 6,6A2,2 0 0,1 4,8A2,2 0 0,1 2,6A2,2 0 0,1 4,4M12,20A2,2 0 0,1 14,22A2,2 0 0,1 12,24A2,2 0 0,1 10,22A2,2 0 0,1 12,20M20,20A2,2 0 0,1 22,22A2,2 0 0,1 20,24A2,2 0 0,1 18,22A2,2 0 0,1 20,20M4,20A2,2 0 0,1 6,22A2,2 0 0,1 4,24A2,2 0 0,1 2,22A2,2 0 0,1 4,20Z"/></svg>
                                                            <span>Столик <strong x-text="tableNumber"></strong></span>
                                                        </div>

                                                        <div class="products-list">
                                                            <template x-for="group in groupedProducts" :key="group.category._id">
                                                                <div class="category-section" :id="'cat-' + group.category._id">
                                                                    <h3 class="category-section-title" x-text="group.category.name"></h3>
                                                                    <div class="category-products" :class="{ 'view-grid': productViewMode === 'grid' }">
                                                                        <template x-for="product in group.products" :key="product._id">
                                                                            <div class="product-card" :class="{ 'combo-card': product.item_type === 'combo' }">
                                                                                <div class="product-info">
                                                                                    <div class="combo-header" x-show="product.item_type === 'combo'">
                                                                                        <span class="combo-badge">КОМБО</span>
                                                                                        <span class="combo-discount" x-text="'-' + Math.round(product.savings / product.regular_price * 100) + '%'"></span>
                                                                                    </div>
                                                                                    <h3 x-text="product.name"></h3>
                                                                                    <template x-if="product.item_type === 'combo'">
                                                                                        <div class="combo-pricing">
                                                                                            <span class="regular-price" x-text="product.regular_price + ' грн'"></span>
                                                                                            <p class="price combo-price" x-text="product.combo_price + ' грн'"></p>
                                                                                        </div>
                                                                                    </template>
                                                                                    <template x-if="product.item_type !== 'combo'">
                                                                                        <p class="price" x-text="product.price + ' грн'"></p>
                                                                                    </template>
                                                                                    <p class="description" x-text="product.description"></p>
                                                                                    <div class="combo-items" x-show="product.item_type === 'combo' && product.items">
                                                                                        <template x-for="ci in product.items" :key="ci.product_id">
                                                                                            <span class="combo-item-tag" x-text="ci.product_name + (ci.qty > 1 ? ' x' + ci.qty : '')"></span>
                                                                                        </template>
                                                                                    </div>
                                                                                    <div class="meta" x-show="product.item_type !== 'combo'">
                                                                                        <span x-show="product.weight" x-text="product.weight"></span>
                                                                                        <span x-show="product.cook_time" x-text="product.cook_time"></span>
                                                                                    </div>
                                                                                    <div class="actions">
                                                                                        <button class="add-btn" @click="addToCart(product, $event)">
                                                                                            <svg viewBox="0 0 24 24"><path d="M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z"/></svg>
                                                                                            додати
                                                                                        </button>
                                                                                        <button class="fav-btn">
                                                                                            <svg viewBox="0 0 24 24"><path d="M12.1,18.55L12,18.65L11.89,18.55C7.14,14.24 4,11.39 4,8.5C4,6.5 5.5,5 7.5,5C9.04,5 10.54,6 11.07,7.36H12.93C13.46,6 14.96,5 16.5,5C18.5,5 20,6.5 20,8.5C20,11.39 16.86,14.24 12.1,18.55M16.5,3C14.76,3 13.09,3.81 12,5.08C10.91,3.81 9.24,3 7.5,3C4.42,3 2,5.41 2,8.5C2,12.27 5.4,15.36 10.55,20.03L12,21.35L13.45,20.03C18.6,15.36 22,12.27 22,8.5C22,5.41 19.58,3 16.5,3Z"/></svg>
                                                                                        </button>
                                                                                    </div>
                                                                                </div>
                                                                                <div class="product-image">
                                                                                    <img :src="product.image" :alt="product.name" onerror="this.src='/static/img/placeholder.png'">
                                                                                </div>
                                                                            </div>
                                                                        </template>
                                                                    </div>
                                                                </div>
                                                            </template>
                                                            <div x-show="groupedProducts.length === 0 || groupedProducts.every(g => g.products.length === 0)" class="empty-state">
                                                                <svg viewBox="0 0 24 24" width="64" height="64" style="fill: var(--color-border);">
                                                                    <path d="M15.5,12C18,12 20,14 20,16.5C20,17.38 19.75,18.21 19.31,18.9L22.39,22L21,23.39L17.88,20.32C17.19,20.75 16.37,21 15.5,21C13,21 11,19 11,16.5C11,14 13,12 15.5,12M15.5,14A2.5,2.5 0 0,0 13,16.5A2.5,2.5 0 0,0 15.5,19A2.5,2.5 0 0,0 18,16.5A2.5,2.5 0 0,0 15.5,14M5,3H19C20.11,3 21,3.89 21,5V13.03C20.5,12.23 19.81,11.54 19,11V5H5V19H9.5C9.81,19.75 10.26,20.42 10.81,21H5C3.89,21 3,20.11 3,19V5C3,3.89 3.89,3 5,3Z"/>
                                                                </svg>
                                                                <h3 x-text="searchQuery ? 'Нічого не знайдено' : 'Тут поки порожньо'"></h3>
                                                                <p x-text="searchQuery ? 'Спробуйте інший запит' : 'Страви з\'являться незабаром'"></p>
                                                            </div>
                                                        </div>
                                                    </main>
                                                </div>
                                            </template>

                                            <!-- Hours -->
                                            <template x-if="el.type === 'hours'">
                                                <div class="info-card">
                                                    <h4>Графік роботи</h4>
                                                    <p>{{ restaurant_hours }}</p>
                                                </div>
                                            </template>

                                            <!-- Address -->
                                            <template x-if="el.type === 'address'">
                                                <div class="info-card info-card-copyable">
                                                    <h4>Адреса</h4>
                                                    <p>{{ restaurant_address }}</p>
                                                    <button class="copy-btn"
                                                            x-show="el.settings?.showCopyButton !== false"
                                                            @click="copyToClipboard('{{ restaurant_address }}', $event)"
                                                            title="Копіювати адресу">
                                                        <svg viewBox="0 0 24 24"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg>
                                                    </button>
                                                </div>
                                            </template>

                                            <!-- Phone -->
                                            <template x-if="el.type === 'phone'">
                                                <div class="info-card info-card-copyable">
                                                    <h4>Телефон</h4>
                                                    <p><a href="tel:{{ restaurant_phone }}">{{ restaurant_phone }}</a></p>
                                                    <button class="copy-btn"
                                                            x-show="el.settings?.showCopyButton !== false"
                                                            @click="copyToClipboard('{{ restaurant_phone }}', $event)"
                                                            title="Копіювати телефон">
                                                        <svg viewBox="0 0 24 24"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg>
                                                    </button>
                                                </div>
                                            </template>

                                            <!-- Map -->
                                            <template x-if="el.type === 'map'">
                                                <div class="info-map" x-show="el.settings?.googleMapsEmbedUrl">
                                                    <iframe :src="el.settings?.googleMapsEmbedUrl"
                                                            width="100%" :height="el.settings?.height || '300px'" style="border:0;"
                                                            allowfullscreen="" loading="lazy"
                                                            referrerpolicy="no-referrer-when-downgrade"></iframe>
                                                </div>
                                            </template>

                                            <!-- Delivery Map -->
                                            <template x-if="el.type === 'delivery_map'">
                                                <div class="delivery-map-widget"
                                                     x-init="$nextTick(() => initDeliveryMap('dmap-' + el.id))">
                                                    <div class="delivery-map-header">
                                                        <h4 x-text="el.settings?.title || 'Зони доставки'"></h4>
                                                        <button class="expand-map-btn" @click="openDeliveryMapModal()">
                                                            <svg viewBox="0 0 24 24" width="16" height="16"><path fill="currentColor" d="M5,5H10V7H7V10H5V5M14,5H19V10H17V7H14V5M17,14H19V19H14V17H17V14M10,17V19H5V14H7V17H10Z"/></svg>
                                                            Розгорнути
                                                        </button>
                                                    </div>
                                                    <div :id="'dmap-' + el.id"
                                                         class="delivery-map-container"
                                                         :style="'height:' + (el.settings?.height || '300px')">
                                                    </div>
                                                    <div class="delivery-map-legend" x-show="deliveryZones.length > 0">
                                                        <template x-for="zone in deliveryZones" :key="zone._id">
                                                            <div class="legend-item">
                                                                <span class="legend-dot" :style="'background:' + zone.color"></span>
                                                                <span class="legend-name" x-text="zone.name"></span>
                                                                <span class="legend-fee" x-text="zone.delivery_fee > 0 ? zone.delivery_fee + ' грн' : 'Безкоштовно'"></span>
                                                            </div>
                                                        </template>
                                                    </div>
                                                </div>
                                            </template>

                                            <!-- Site Pages -->
                                            <template x-if="el.type === 'site_pages'">
                                                <div class="site-pages-widget"
                                                     x-init="$nextTick(() => _loadSitePages())">
                                                    <div class="site-pages-header" x-show="el.settings?.title">
                                                        <h4 x-text="el.settings?.title || 'Корисні сторінки'"></h4>
                                                    </div>
                                                    <div class="site-pages-list" x-show="sitePages.length > 0">
                                                        <template x-for="sp in sitePages" :key="sp._id">
                                                            <a class="site-page-card" :href="'/pages/' + sp._id">
                                                                <template x-if="sp.cover_image">
                                                                    <img :src="sp.cover_image" :alt="sp.title" class="site-page-thumb" loading="lazy">
                                                                </template>
                                                                <div class="site-page-card-body">
                                                                    <span class="site-page-card-title" x-text="sp.title"></span>
                                                                    <span class="site-page-card-desc" x-show="sp.description"
                                                                          x-text="sp.description.length > 80 ? sp.description.slice(0, 80) + '…' : sp.description"></span>
                                                                </div>
                                                                <svg class="site-page-arrow" viewBox="0 0 24 24" width="18" height="18"><path fill="currentColor" d="M8.59,16.58L13.17,12L8.59,7.41L10,6L16,12L10,18L8.59,16.58Z"/></svg>
                                                            </a>
                                                        </template>
                                                    </div>
                                                    <div class="site-pages-empty" x-show="sitePages.length === 0">
                                                        <svg viewBox="0 0 24 24" width="32" height="32" style="opacity:0.3"><path fill="currentColor" d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/></svg>
                                                        <span>Сторінок ще немає</span>
                                                    </div>
                                                </div>
                                            </template>

                                            <!-- Spacer -->
                                            <template x-if="el.type === 'spacer'">
                                                <div class="spacer-element" :style="'height:' + (el.settings?.height || '20px')">
                                                    <hr x-show="el.settings?.showDivider"
                                                        :style="'border-color:' + (el.settings?.dividerColor || 'var(--color-border)')">
                                                </div>
                                            </template>

                                            <!-- Social Links -->
                                            <template x-if="el.type === 'social'">
                                                <div class="social-links" :class="(el.settings?.layout || 'horizontal') === 'vertical' ? 'social-vertical' : 'social-horizontal'">
                                                    <template x-for="link in (el.settings?.links || [])" :key="link.platform">
                                                        <a :href="link.url" target="_blank" rel="noopener" class="social-link" :title="link.platform" x-text="link.platform"></a>
                                                    </template>
                                                </div>
                                            </template>

                                            <!-- Custom HTML -->
                                            <template x-if="el.type === 'custom_html'">
                                                <div class="custom-html-element" x-html="el.settings?.htmlContent || ''"></div>
                                            </template>

                                        </div>
                                    </template>
                                </div>
                            </template>
                        </div>
                    </template>
                </div>
            </div>
        </template>
    </div>

    <!-- Feedback Modal -->
    <div class="feedback-modal" x-cloak x-show="showFeedback" x-transition @click.self="showFeedback = false" role="dialog" aria-modal="true" aria-label="Залишити відгук">
        <div class="feedback-content">
            <div class="feedback-header">
                <h3>Залишити відгук</h3>
                <button @click="showFeedback = false" aria-label="Закрити"><span aria-hidden="true">&times;</span></button>
            </div>

            <div class="feedback-body">
                <div class="rating-group">
                    <label class="form-label">Оцінка *</label>
                    <div class="star-rating">
                        <template x-for="star in 5" :key="star">
                            <button type="button" class="star-btn"
                                    :class="{ 'active': feedbackRating >= star }"
                                    @click="feedbackRating = star">
                                <svg viewBox="0 0 24 24">
                                    <path d="M12,17.27L18.18,21L16.54,13.97L22,9.24L14.81,8.62L12,2L9.19,8.62L2,9.24L7.45,13.97L5.82,21L12,17.27Z"/>
                                </svg>
                            </button>
                        </template>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Номер телефону</label>
                    <input type="tel" class="form-input"
                           x-model="feedbackPhone"
                           placeholder="+380...">
                </div>

                <div class="form-group">
                    <label class="form-label">Коментар</label>
                    <textarea class="form-input"
                              x-model="feedbackComment"
                              rows="4"
                              placeholder="Ваш відгук про наш заклад..."></textarea>
                </div>
            </div>

            <div class="feedback-footer">
                <button class="btn btn-outline" @click="showFeedback = false">Скасувати</button>
                <button class="btn btn-primary"
                        @click="submitFeedback()"
                        :disabled="feedbackRating === 0 || feedbackSubmitting">
                    <span x-show="!feedbackSubmitting">Надіслати</span>
                    <span x-show="feedbackSubmitting">Надсилання...</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Feedback Success Toast -->
    <div class="toast" role="alert" aria-live="polite" x-show="feedbackSuccess" x-transition.opacity
         x-init="$watch('feedbackSuccess', val => { if(val) setTimeout(() => feedbackSuccess = false, 3000) })">
        <svg viewBox="0 0 24 24"><path d="M12 2C6.5 2 2 6.5 2 12S6.5 22 12 22 22 17.5 22 12 17.5 2 12 2M10 17L5 12L6.41 10.59L10 14.17L17.59 6.58L19 8L10 17Z"/></svg>
        <span>Дякуємо за ваш відгук!</span>
    </div>

    <!-- Cart Modal -->
    <div class="cart-modal" x-show="showCart" x-transition @click.self="showCart = false" role="dialog" aria-modal="true" aria-label="Кошик">
        <div class="cart-content">
            <div class="cart-header">
                <h3>Кошик</h3>
                <button @click="showCart = false" aria-label="Закрити"><span aria-hidden="true">&times;</span></button>
            </div>

            <!-- Step Indicator -->
            <div class="cart-steps" x-show="cart.length > 0">
                <div class="cart-step" :class="{ active: true, completed: cart.length > 0 }">
                    <span class="cart-step-number">1</span>
                    <span>Кошик</span>
                </div>
                <div class="cart-step-line" :class="{ filled: cart.length > 0 }"></div>
                <div class="cart-step" :class="{ active: cart.length > 0 }">
                    <span class="cart-step-number">2</span>
                    <span>Деталі</span>
                </div>
                <div class="cart-step-line"></div>
                <div class="cart-step">
                    <span class="cart-step-number">3</span>
                    <span>Готово</span>
                </div>
            </div>

            <div class="cart-items" x-show="cart.length > 0">
                <template x-for="(item, index) in cart" :key="index">
                    <div class="cart-item">
                        <div class="item-info">
                            <span class="item-name" x-text="item.name"></span>
                            <span class="item-price" x-text="item.price + ' грн'"></span>
                        </div>
                        <div class="item-qty">
                            <button @click="decreaseQty(index)" aria-label="Зменшити кількість">-</button>
                            <span x-text="item.qty" aria-label="Кількість"></span>
                            <button @click="increaseQty(index)" aria-label="Збільшити кількість">+</button>
                        </div>
                        <button class="remove-btn" @click="removeFromCart(index)" aria-label="Видалити товар"><span aria-hidden="true">&times;</span></button>
                    </div>
                </template>
            </div>

            <div class="cart-empty" x-show="cart.length === 0">
                <p>Кошик порожній</p>
            </div>

            <div class="cart-footer" x-show="cart.length > 0">
                <!-- Order Type Selection -->
                <div class="order-type-section">
                    <label class="section-label">Тип замовлення</label>
                    <div class="order-type-options">
                        <label class="order-type-option">
                            <input type="radio" x-model="orderType" value="dine_in">
                            <span>В залі</span>
                        </label>
                        <label class="order-type-option">
                            <input type="radio" x-model="orderType" value="takeaway">
                            <span>З собою</span>
                        </label>
                        <label class="order-type-option">
                            <input type="radio" x-model="orderType" value="delivery">
                            <span>Доставка</span>
                        </label>
                    </div>
                </div>

                <!-- Payment Method Selection -->
                <div class="payment-method-section">
                    <label class="section-label">Спосіб оплати</label>
                    <div class="order-type-options">
                        <label class="order-type-option">
                            <input type="radio" x-model="paymentMethod" value="cash">
                            <span>Готівка</span>
                        </label>
                        <label class="order-type-option">
                            <input type="radio" x-model="paymentMethod" value="card">
                            <span>Картка</span>
                        </label>
                        <label class="order-type-option">
                            <input type="radio" x-model="paymentMethod" value="online">
                            <span>Онлайн</span>
                        </label>
                    </div>
                </div>

                <!-- Delivery Section -->
                <div class="delivery-section" x-show="orderType === 'delivery'" x-transition>
                    <label class="section-label">Адреса доставки</label>
                    <div class="address-input-row">
                        <input type="text"
                               x-model="deliveryAddress"
                               @input="deliveryChecked = false; deliveryZone = null; deliveryError = ''"
                               placeholder="вул. Незалежності, 36"
                               class="delivery-input"
                               :disabled="deliveryLoading">
                        <button type="button"
                                class="check-address-btn"
                                @click="checkDeliveryAddress()"
                                :disabled="deliveryLoading || !deliveryAddress.trim()">
                            <span x-show="!deliveryLoading">Перевірити</span>
                            <span x-show="deliveryLoading">...</span>
                        </button>
                    </div>
                    <div class="delivery-message error" x-show="deliveryError" x-text="deliveryError"></div>
                    <div class="zone-result-card" x-show="deliveryZone?.available" x-transition>
                        <div class="zone-name">
                            <span class="zone-icon">&#10003;</span>
                            <span x-text="deliveryZone?.zone_name"></span>
                        </div>
                        <div class="zone-details">
                            <div class="zone-fee">
                                <span>Доставка:</span>
                                <span x-text="getDeliveryFee() === 0 ? 'Безкоштовно' : getDeliveryFee() + ' грн'"></span>
                            </div>
                            <div class="zone-min" x-show="deliveryZone?.min_order_amount > 0">
                                <span>Мін. замовлення:</span>
                                <span x-text="deliveryZone?.min_order_amount + ' грн'"></span>
                            </div>
                            <template x-if="deliveryZone?.free_delivery_threshold && getSubtotal() < deliveryZone?.free_delivery_threshold">
                                <div class="zone-threshold">
                                    <span class="threshold-hint">
                                        Безкоштовна доставка від <span x-text="deliveryZone?.free_delivery_threshold"></span> грн
                                    </span>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>

                <!-- Promo Code -->
                <div class="promo-section">
                    <div class="promo-input-row">
                        <input type="text"
                               x-model="promoCode"
                               placeholder="Промокод"
                               class="promo-input"
                               :disabled="promoApplied"
                               @keyup.enter="applyPromoCode()">
                        <button class="promo-btn"
                                @click="promoApplied ? removePromoCode() : applyPromoCode()"
                                :class="{ 'applied': promoApplied }">
                            <span x-text="promoApplied ? 'Скасувати' : 'Застосувати'"></span>
                        </button>
                    </div>
                    <div class="promo-message" x-show="promoMessage" :class="{ 'error': promoError, 'success': !promoError }">
                        <span x-text="promoMessage"></span>
                    </div>
                </div>

                <div class="cart-total">
                    <div class="subtotal">
                        <span>Сума товарів:</span>
                        <span x-text="getSubtotal() + ' грн'"></span>
                    </div>
                    <div class="delivery-fee-row" x-show="orderType === 'delivery' && deliveryZone?.available">
                        <span>Доставка:</span>
                        <span x-text="getDeliveryFee() === 0 ? 'Безкоштовно' : getDeliveryFee() + ' грн'"></span>
                    </div>
                    <div class="discount" x-show="promoApplied && discountAmount >= customerDiscountAmount">
                        <span>Знижка (промокод):</span>
                        <span class="discount-value" x-text="'-' + discountAmount + ' грн'"></span>
                    </div>
                    <div class="discount customer-discount" x-show="customerDiscountPercent > 0 && customerDiscountAmount > discountAmount">
                        <span x-text="customerDiscountLabel"></span>
                        <span class="discount-value" x-text="'-' + customerDiscountAmount + ' грн'"></span>
                    </div>
                    <div class="surcharge-row" x-show="getCardSurcharge() > 0">
                        <span x-text="'Комісія за картку (' + cardSurchargePercent + '%)'"></span>
                        <span class="surcharge-value" x-text="'+' + getCardSurcharge() + ' грн'"></span>
                    </div>
                    <div class="total-row">
                        <span>Всього:</span>
                        <span x-text="getTotal() + ' грн'"></span>
                    </div>
                </div>

                <!-- Customer Info Section -->
                <div class="customer-section cart-form-section">
                    <label class="section-label">Контактна інформація</label>

                    <div class="customer-field">
                        <label class="cart-form-label">
                            <span x-text="orderType === 'delivery' ? 'Телефон *' : 'Телефон (опціонально)'"></span>
                        </label>
                        <input type="tel"
                               class="cart-form-input"
                               x-model="customerPhone"
                               @blur="lookupCustomer()"
                               placeholder="+380..."
                               :required="orderType === 'delivery'">
                        <div class="customer-lookup-status" x-show="customerLookupLoading">
                            <span class="lookup-spinner"></span> Пошук клієнта...
                        </div>
                    </div>

                    <div class="customer-field">
                        <label class="cart-form-label">Ім'я (опціонально)</label>
                        <input type="text"
                               class="cart-form-input"
                               x-model="customerName"
                               placeholder="Ваше ім'я">
                    </div>

                    <!-- Customer recognized indicator -->
                    <div class="customer-recognized" x-show="customerFound" x-transition>
                        <div class="customer-badge">
                            <span class="customer-check-icon">&#10003;</span>
                            <span x-text="'Вітаємо, ' + (customerName || customerPhone) + '!'"></span>
                        </div>
                        <div class="customer-stats" x-show="customerOrderCount > 0">
                            <span x-text="'Замовлень: ' + customerOrderCount"></span>
                            <span x-text="'Сума: ' + customerTotalSpent + ' грн'"></span>
                        </div>
                    </div>
                </div>

                <button class="checkout-btn" @click="checkout()">Оформити замовлення</button>
            </div>
        </div>
    </div>

    <!-- Floating Cart Button (Mobile) -->
    <button class="floating-cart-btn"
            x-show="cart.length > 0"
            x-transition
            @click="showCart = true"
            x-cloak>
        <svg viewBox="0 0 24 24"><path d="M17,18C15.89,18 15,18.89 15,20A2,2 0 0,0 17,22A2,2 0 0,0 19,20C19,18.89 18.1,18 17,18M1,2V4H3L6.6,11.59L5.24,14.04C5.09,14.32 5,14.65 5,15A2,2 0 0,0 7,17H19V15H7.42A0.25,0.25 0 0,1 7.17,14.75C7.17,14.7 7.18,14.66 7.2,14.63L8.1,13H15.55C16.3,13 16.96,12.58 17.3,11.97L20.88,5.5C20.95,5.34 21,5.17 21,5A1,1 0 0,0 20,4H5.21L4.27,2M7,18C5.89,18 5,18.89 5,20A2,2 0 0,0 7,22A2,2 0 0,0 9,20C9,18.89 8.1,18 7,18Z"/></svg>
        <span class="floating-cart-count" x-text="cart.reduce((a,b) => a + b.qty, 0)"></span>
        <span class="floating-cart-divider"></span>
        <span class="floating-cart-total" x-text="getSubtotal() + ' грн'"></span>
    </button>

    <!-- Delivery Map Fullscreen Modal -->
    <div class="delivery-map-modal" x-cloak x-show="deliveryMapModal" x-transition.opacity @click.self="closeDeliveryMapModal()" role="dialog" aria-modal="true" aria-label="Зони доставки">
        <div class="delivery-map-modal-content">
            <div class="delivery-map-modal-header">
                <h3>Зони доставки</h3>
                <button @click="closeDeliveryMapModal()" aria-label="Закрити"><span aria-hidden="true">&times;</span></button>
            </div>
            <div id="delivery-map-modal-map" class="delivery-map-modal-map"
                 x-init="$watch('deliveryMapModal', v => { if(v) $nextTick(() => initDeliveryMap('delivery-map-modal-map', true)) })">
            </div>
            <div class="delivery-map-legend delivery-map-modal-legend" x-show="deliveryZones.length > 0">
                <template x-for="zone in deliveryZones" :key="'modal-' + zone._id">
                    <div class="legend-item">
                        <span class="legend-dot" :style="'background:' + zone.color"></span>
                        <span class="legend-name" x-text="zone.name"></span>
                        <span class="legend-fee" x-text="zone.delivery_fee > 0 ? zone.delivery_fee + ' грн' : 'Безкоштовно'"></span>
                        <span class="legend-min" x-show="zone.min_order_amount > 0" x-text="'(мін. ' + zone.min_order_amount + ' грн)'"></span>
                    </div>
                </template>
            </div>
        </div>
    </div>

    <!-- Order Success Modal -->
    <div class="success-modal" x-show="orderSuccess" x-transition>
        <div class="success-content">
            <div class="success-icon">
                <svg viewBox="0 0 24 24"><path d="M12 2C6.5 2 2 6.5 2 12S6.5 22 12 22 22 17.5 22 12 17.5 2 12 2M10 17L5 12L6.41 10.59L10 14.17L17.59 6.58L19 8L10 17Z"/></svg>
            </div>
            <h3>Замовлення прийнято!</h3>
            <p>Номер замовлення: <strong x-text="orderNumber"></strong></p>
            <button @click="orderSuccess = false">OK</button>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
const categoriesData = {{ categories | tojson }};
const productsData = {{ products | tojson }};
let storefrontConfig = {{ storefront_config | tojson }};
const orderTypesData = {{ order_types | tojson }};
const cardSurchargePercent = {{ card_surcharge_percent | default(0) }};
const mediaSliderData = {{ media_slider | tojson }};

// Preview mode: override layout config from Page Builder (sessionStorage)
(function() {
    if (new URLSearchParams(window.location.search).get('preview') !== '1') return;
    try {
        const d = sessionStorage.getItem('pb_preview_config');
        if (d) storefrontConfig = JSON.parse(d);
    } catch(e) {}
    // Show preview banner
    document.addEventListener('DOMContentLoaded', function() {
        var b = document.getElementById('pb-preview-banner');
        if (b) b.style.display = 'flex';
    });
})();
</script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="/static/js/menu.js"></script>
{% endblock %}
